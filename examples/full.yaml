# Full Imaging Workflow Example
# Demonstrates all actions with template variables and conditionals.
#
# Run with:
#   set IMAGE_ID=win11-v2
#   set GLAZIER_STAGE=0
#   .\glazier.exe -config_root_path .\examples\full.yaml

controls:
  - policy: ["os_version", "device_model"]

tasks:
  # 1. Prepare Storage & Encryption
  - stage.set: "10"

  {{if .ImageID}}
  - bitlocker.enable:
      mode: tpm
      backup: true
  {{end}}

  # 2. Install Core Software (image-specific packages)
  - stage.set: "50"
  - googet.install:
      packages:
        - base-image-{{.ImageID}}
        - config-{{.Hostname}}
        - google-chrome-stable
        - 7zip
      reinstall: true
      db_only: false

  # 3. Join Domain
  - domain.join:
      domain: "example.com"
      ou: "OU=Workstations,OU={{.Username}},DC=example,DC=com"
      user: "join_user"
      password: "secret_password"

  # 4. Schedule Startup Tasks
  - task.create:
      name: "FinalizeSetup-{{.Hostname}}"
      command: "C:\\Windows\\System32\\cmd.exe"
      args: ["/c", "echo Setup Complete for {{.Hostname}} at {{.Timestamp}}"]
      trigger: "boot"

  # 5. Finalize
  - stage.set: "100"
  - system.power:
      type: reboot
      delay: 10
      reason: installation
